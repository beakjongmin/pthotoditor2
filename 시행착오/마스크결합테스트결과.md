# 마스크 결합 문제 해결 기록

## 📊 실험: Soft Alpha Mask vs Hard Alpha Mask

### ✅ 해결 배경:

`SegmentationMask` 모델의 buffer에서 알파 마스크를 생성할 때,
confidence 값이 지정된 threshold보다 높으면 255, 그 이하는 0으로 설정한 **Hard Alpha Mask** 방식이 더 정교하고 안정적인 결과를 보였다.

```kotlin
fun toHardAlphaMask(
    mask: SegmentationMask,
    width: Int,
    height: Int,
    threshold: Float = 0.6f
): Bitmap {
    val buffer = mask.buffer
    buffer.rewind()
    val pixels = IntArray(width * height)

    for (i in pixels.indices) {
        val confidence = buffer.float
        val alpha = if (confidence >= threshold) 255 else 0
        pixels[i] = (alpha shl 24) or 0xFFFFFF
    }

    return Bitmap.createBitmap(pixels, width, height, Bitmap.Config.ARGB_8888)
}
```

```kotlin
fun toSoftAlphaMask(
    mask: SegmentationMask,
    width: Int,
    height: Int
): Bitmap {
    val buffer = mask.buffer
    buffer.rewind()
    val pixels = IntArray(width * height)

    for (i in pixels.indices) {
        val confidence = buffer.float
        val alpha = (confidence * 255).toInt().coerceIn(0, 255)
        pixels[i] = (alpha shl 24) or 0xFFFFFF
    }

    return Bitmap.createBitmap(pixels, width, height, Bitmap.Config.ARGB_8888)
}

```

---

## 🔢 패턴 통계 데이터:

```
faceAlphaMask:
- alpha=0:     61632
- alpha=255:  164688

jawlineMask:
- alpha=0:     135054
- alpha=255:   91266

faceHairMask:
- alpha=0:     70450
- alpha=255:  155870
```

### 📌 Soft mask를 사용하는 경우:

* alpha 값이 1\~254인 경계 픽셀이 blending 시 중간값으로 적용되지 않으면 효과가 무시됨
* 미세한 그라데이션 표현이 가능한 대신 처리 결과가 예상 외로 번질 수 있음

### 📌 Hard mask를 사용하는 경우:

* 255/0 으로 이진 처리되므로 마스킹/블렌딩 처리 결과가 명확함
* 경계 처리가 날카로울 수 있으나 feathering을 병행하면 자연스러움 확보 가능

---

## 🛠 문제 해결 과정:

1. 기존에는 `toGrayMat()` 함수를 통해 마스크를 생성했으나, 이 방식은 색상의 밝기를 기준으로 처리하여 불완전한 영역 인식 발생
2. `toAlphaMat()`을 도입하여 실제 알파 채널 기반의 정밀한 마스크 처리 구현
3. SoftMask보다 HardMask의 blending 결과가 통계적으로 더 일관되고 품질이 높았음

---

## 💡 결론:

* "머리카락과 얼굴을 포함한 최종 마스크"는 segmentMask와 jawlineMask가 정확한 alpha 채널을 가지고 있어야 정확한 영역 블렌딩이 가능
* SoftMask는 blending 강도나 feathering 조건이 정밀하지 않으면 효과가 반영되지 않음
* HardMask는 원하는 영역만 정확하게 처리 가능하며, feather 마스크로 부드러운 경계 구현이 가능

---

이 기록은 향후 마스크 결합 처리 및 blending 처리 최적화 작업 시 기준점이 될 수 있다.
